# Access Finland MVP Security Features

The Access Finland MVP application is a web app that has authentication features and handles sensitive information. The following sections describe the security features of the application that make sure the authentication and other private data features are safe to use.

Additionally the application is not published to public internet, but is only accessible with login credentials managed by AWS Cognito service. 

The app codebase, as a monorepo, supports multiple deployable apps with different security measures. The following sections describe the security features of the MVP app. The other apps are not described in this document.

## Application Security Features

### Authentication

The application uses [OpenID Connect](https://openid.net/connect/) for authentication and [Sinuna](https://sinuna.fi) as the identity provider. The used authentication flow is the [Authorization Code Flow](https://openid.net/specs/openid-connect-core-1_0.html#CodeFlowAuth) that provide a relatively short-lived access token from a successful login. The app uses the access token as a session, so that when the token expires so does the session.

The login flow is as follows:

1. The user clicks the login button in the frontend app
2. The frontend app redirects the user to Sinuna login page (by a backend app redirect)
3. The user logs in with Sinuna credentials / Or the user is already logged in
4. Sinuna redirects the user back to the backend app with a grant token
5. The backend app exchanges (with Sinuna) the grant token to an access token
6. The backend app stores the access token to a server-side encrypted session cookie with the same expiration time as the access token
7. The app redirects the user to the frontend app
8. The frontend app makes request to the backend app that uses the access token from the session cookie to authenticate the user in external API calls for example to the dataspace gateway.

The backend login flow routes are defined in the [../apps/af-mvp/src/pages/api/auth](../apps/af-mvp/src/pages/api/auth) folder.

### Authorization

After a succesful login flow the restricted backend app routes are accessible to the user. The backend app routes are protected by a [loggedInAuthMiddleware](../apps/af-mvp/src/lib/backend/middleware/auth.ts)-middleware that checks the session cookie validity. The access token validity is checked by the external services (Users API) that the backend app calls with the access token, and therefore there's no prevalidation for it in the mvp backend app. 

### Data Protection

#### Session Cookie

Session cookie data is stored in a server-side encrypted cookie. The cookie is encrypted with a key that is generated by the Pulumi deployment and stored in the backend app container image as an environment variable. The key is only accessible to the backend app. The cookie is also set to be HttpOnly and Secure, so that it can't be accessed by the frontend app or by a non-secure connection.

#### CSFR (Cross Site Request Forgery) protection

The backend app routes that are protected by the [loggedInAuthMiddleware](../apps/af-mvp/src/lib/backend/middleware/auth.ts) also include a check that the request has a valid CSRF token. The CSRF token is generated by the backend app on the login flow phase and is stored in the session cookie and to the frontend apps local storage. The frontend app includes the CSRF token in the request header, and the backend app checks that the token matches the session.

#### Data Storage Summary

- The backend app stores the session cookie data to a server-side encrypted, HttpOnly and Secure cookie
- The frontend app stores the CSRF token to the local storage
- The data the frontend app retrieves from the backend app is stored in the frontend app memory and is not persisted to the disk

### API Security

The backend app routes are protected with strict content security policies and other security headers using the [next-safe](https://www.npmjs.com/package/next-safe) library to provide sensible defaults and simple customization. The next-safe configurations are defined in the [../apps/af-mvp/next.config.js](../apps/af-mvp/next.config.js) file. 

## Public Access To The Application

The application is not published to public internet, but is only accessible with login credentials. The access restriction is implemented using the AWS Web Application Firewall (WAF) and the login flow is implemented using the AWS Cognito service. The following sections describe the implementation details.

### AWS WAF

The application is deployed using cloudfront distribution that is protected by a WAF. The WAF is configured to only allow access if the request has a valid cognito session cookie. The invalid requests are redirected to the cognito login page. The WAF configuration is defined in the [../infra/af-mvp/resources/webApplicationFirewall.ts](../infra/af-mvp/resources/webApplicationFirewall.ts) file. 

A quick setting for enabling or disabling the WAF is defined in the stage specific pulumi configuration files eg: [../infra/af-mvp/Pulumi.mvp-staging.yaml](../infra/af-mvp/Pulumi.mvp-staging.yaml) in the `waf:enabled` field.

### AWS Cognito

The application uses AWS Cognito service for granting access to the site. The cognito configuration is defined in the [../infra/af-mvp/resources/cognito.ts](../infra/af-mvp/resources/cognito.ts) file.


#### Cognito User Pool

The user pool can be configured to deploy with a static user using the `waf:username` and `waf:username` settings in the pulumi config. Otherwise the user management is done in the AWS Cognito console.

### Integration specifics

The combination of AWS WAF, Cognito and the application codebase is implemented with the following responsibilities:

- WAF: 
  - Guards the access to the application
  - Redirects unauthorized requests to the cognito login page
- Cognito: 
  - Provides the login page and the login flow
  - After a successful login redirects user to backend app with a grant token
- Backend app: 
  - Handles the login flow
  - Stores the cognito session to a cookie
  - Redirects user to frontend app
- Frontend app: 
  - Verifies the cognito session with a request to the backend app
  - Reloads the page if the session is not valid causing the WAF to redirect to the cognito login page.

The login flow is as follows:

1. The unauthenticated user navigates to the frontend app url
2. The WAF blocks the request and redirects the user to the cognito login page
3. The user logs in with cognito credentials
4. The cognito redirects the user to the backend app with an access token
5. The backend app then:
    - verifies the token with cognito
    - stores the token an encrypted backend cookie
    - stores frontend app access key to a cookie that's visible to the WAF
      - the frontend app access key is shared with the WAF and is generated by the pulumi deployment
    - redirects the user to the frontend app
6. The WAF allows the request to the frontend app because the frontend app access key is present
7. The frontend app then:
    - verifies the congito session with a request to the backend app
    - the verification is re-checked on every page load
    - on a verification failure:
      - the backend app clears the session cookies
      - the frontend app reloads the page
      - the WAF blocks the request and redirects the user to the cognito login page


