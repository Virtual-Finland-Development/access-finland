# Access Finland MVP Security Features

The Access Finland MVP application is a web app that has authentication features and handles sensitive information. The following sections describe the security features of the application that make sure the authentication and other private data features are safe to use.

Additinally the application is not published to public internet, but is only accessible with login credentials managed by AWS Cognito service. 

The app codebase, as a monorepo, supports multiple deployable apps with different security measures. The following sections describe the security features of the MVP app. The other apps are not described in this document.

## Application Security Features

### Authentication

The application uses [OpenID Connect](https://openid.net/connect/) for authentication and [Sinuna](https://sinuna.fi) as the identity provider. The used authentication flow is the [Authorization Code Flow](https://openid.net/specs/openid-connect-core-1_0.html#CodeFlowAuth) that provide a relatively short-lived access token from a successful login. The app uses the access token as a session, so that when the token expires so does the session.

The login flow is as follows:

1. The user clicks the login button in the frontend app
2. The frontend app redirects the user to Sinuna login page (by a backend app redirect)
3. The user logs in with Sinuna credentials / Or the user is already logged in
4. Sinuna redirects the user back to the backend app with a grant token
5. The backend app exchanges (with Sinuna) the grant token to an access token
6. The backend app stores the access token to a server-side encrypted session cookie with the same expiration time as the access token
7. The app redirects the user to the frontend app main page
8. The frontend app makes request to the backend app that uses the access token from the session cookie to authenticate the user in external API calls for example to the dataspace gateway.

The backend login flow routes are defined in the [../apps/af-mvp/src/pages/api/auth](../apps/af-mvp/src/pages/api/auth) folder.

### Authorization

After a succesful login flow the restricted backend app routes are accessible to the user. The backend app routes are protected by a [loggedInAuthMiddleware](../apps/af-mvp/src/lib/backend/middleware/auth.ts)-middleware that checks the session cookie validity. The access token validity is checked by the external services (Users API) that the backend app calls with the access token, and therefore there's no prevalidation for it in the mvp backend app. 

### Data Protection

#### Session Cookie

Session cookie data is stored in a server-side encrypted cookie. The cookie is encrypted with a key that is generated by the Pulumi deployment and stored in the backend app container image as an environment variable. The key is only accessible to the backend app. The cookie is also set to be HttpOnly and Secure, so that it can't be accessed by the frontend app or by a non-secure connection.

#### CSFR (Cross Site Request Forgery) protection

The backend app routes that are protected by the [loggedInAuthMiddleware](../apps/af-mvp/src/lib/backend/middleware/auth.ts) also include a check that the request has a valid CSRF token. The CSRF token is generated by the backend app on the login flow phase and is stored in the session cookie and to the frontend apps local storage. The frontend app includes the CSRF token in the request header, and the backend app checks that the token matches the session.

### Data Storage Summary

- The backend app stores the session cookie data to a server-side encrypted HttpOnly and Secure cookie
- The frontend app stores the CSRF token to the local storage
- The data the frontend app retrieves from the backend app is stored in the frontend app memory and is not persisted to the disk

## Public Access To The Application

The application is not published to public internet, but is only accessible with login credentials. The access restriction is implemented using the AWS Web Application Firewall (WAF) and the login flow is implemented using the AWS Cognito service. The following sections describe the implementation details.

### AWS WAF

The application is deployed using cloudfront distribution that is protected by a WAF. The WAF is configured to only allow access if the request has a valid Cognito session cookie. The invalid requests are redirected to the Cognito login page. The WAF configuration is defined in the [../infra/af-mvp/resources/webApplicationFirewall.ts](../infra/af-mvp/resources/webApplicationFirewall.ts) file.

### AWS Cognito

The application uses AWS Cognito service for granting access to the site. The Cognito configuration is defined in the [../infra/af-mvp/resources/cognito.ts](../infra/af-mvp/resources/cognito.ts) file.

